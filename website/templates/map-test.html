{% extends "base.html" %}
{% block title %}Map{% endblock %}
{% block content %}
<html>
  <head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
    <style>
      .child {
        border: 1px solid black;
        float: left;
        width: 80%;
        margin-left: 20%;
      }
      .parent {
        width: 100%;
      }
      @media (min-width: 768px) {
        .parent {
          display: flex;
          flex-direction: row-reverse;
        }
        .sidebar {
          width: 80%;
        }
      }
      .popup {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 10000;
      }
      .popup-content {
        position: relative;
        background-color: #fff;
        margin: 10% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-height: 70%;
        overflow-y: auto;
      }
      .close {
        position: absolute;
        top: 10px;
        right: 25px;
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }
      .scrollable-menu {
        max-height: 400px;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <section class="parent">
      <!-- Sidebar -->
      <section class="child">
        <div style="float:left;">
          <form method="POST">
            <div id="sidebar" class="section">
              <div class="row"></div>
              <div class="col-md-3 sidebar" style="background-color: #f8f9fa; padding: 20px; height: 100vh; position: fixed; left: 0; width: 25vw; overflow-y: auto;">
                <h4>Journey Details</h4>
                <div class="station-info">
                  <ul>
                    <li>
                      <label>Start Station: </label>
                      <select name="start">
                        {% for d in all_station_codes %}
                          {% if d == selectStart %}
                            <option selected value="{{ d }}">{{ d }}</option>
                          {% else %}
                            <option value="{{ d }}">{{ d }}</option>
                          {% endif %}
                        {% endfor %}
                      </select>
                    </li>
                    <li>
                      <label>End Station: </label>
                      <select name="dest">
                        {% for a in all_station_codes %}
                          {% if a == selectDest %}
                            <option selected value="{{ a }}">{{ a }}</option>
                          {% else %}
                            <option value="{{ a }}">{{ a }}</option>
                          {% endif %}
                        {% endfor %}
                      </select>
                    </li>
                  </ul>
                  <p><label>Select Algorithm</label></p>
                  <p>
                    <select name="algorithm_selection">
                      <option value="1">Breadth First Search</option>
                      <option value="2">Dijkstra</option>
                      <option value="3">K Shortest Path</option>
                      <option value="4">A Star</option>
                    </select>
                  </p>
                  <button type="submit" class="btn btn-primary">Calculate</button>
                  <div id="distance">
                    <p>Distance: </p>
                    <p>{{ distance }}</p>
                  </div>
                  <div id="time">
                    <p>Time: </p>
                    <p>{{ time }}</p>
                  </div>
                  <label>Shortest Route (codes): </label>
                  <ul>
                    {% for code in path_codes %}
                      <li>{{ code }}</li>
                    {% endfor %}
                  </ul>
                  <br>
                  <label>Shortest Route (names): </label>
                  <ul>
                    {% for name in path_names %}
                      <li>{{ name }}</li>
                    {% endfor %}
                  </ul>
                </div>
                <button id="show-old-route" class="btn btn-primary" type="button">Past Routes</button>
                <button id="settings" class="btn btn-primary" type="button">Settings</button>
                <div id="oldRoutesPopup" class="popup" style="display: none;">
                  <div class="popup-content">
                    <span class="close" id="closePopup">&times;</span>
                    <h3>Your Recent Routes</h3>
                    <div class="scrollable-menu">
                      {% if past_routes %}
                        <table class="table table-striped">
                          <thead>
                            <tr>
                              <th>From</th>
                              <th>To</th>
                              <th>Distance</th>
                              <th>Time</th>
                              <th>Station Codes</th>
                              <th>Station names</th>
                            </tr>
                          </thead>
                          <tbody>
                            {% for route in past_routes %}
                              <tr>
                                <td>{{ route.start }}</td>
                                <td>{{ route.dest }}</td>
                                <td>{{ route.distance }} km</td>
                                <td>{{ route.time }} min</td>
                                <td>
                                  <button class="btn btn-info btn-sm" onclick="loadRoute('{{ route.start }}', '{{ route.dest }}')">Load</button>
                                  <a href="{{ url_for('map.delete_route', route_id=route.id) }}" onclick="return confirm('Are you sure you want to delete this route?')" class="btn btn-danger btn-sm">Delete</a>
                                </td>
                              </tr>
                            {% endfor %}
                          </tbody>
                        </table>
                      {% else %}
                        <p>No past routes found.</p>
                      {% endif %}
                    </div>
                  </div>
                </div>
                <script>
                  document.getElementById('show-old-route').addEventListener('click', function() {
                    document.getElementById('oldRoutesPopup').style.display = 'block';
                  });
                  document.getElementById('closePopup').addEventListener('click', function() {
                    document.getElementById('oldRoutesPopup').style.display = 'none';
                  });
                  window.onclick = function(event) {
                    if (event.target == document.getElementById('oldRoutesPopup')) {
                      document.getElementById('oldRoutesPopup').style.display = 'none';
                    }
                  };
                </script>
              </div>
            </div>
          </form>
        </div>
      </section>

      const routeCoordinates = [
        {% for coord in path_coords %}
          [{{ coord[0] }}, {{ coord[1] }}],
        {% endfor %}
      ];
      
      <!-- Map -->
      <script>
        const map = L.map('map').setView([1.3521, 103.8198], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19
        }).addTo(map);

        const routeLine = L.polyline(routeCoordinates, {
          color: 'blue',
          weight: 5
        }).addTo(map);

        map.fitBounds(routeLine.getBounds());
      </script>




    </section>
    <div style="margin: 20px;">
      {% if user.is_authenticated %}
        <button class="btn btn-primary" type="button" onclick="togglePastRoutes()">
          Show/Hide Past Routes
        </button>
        <div id="pastRoutesSection" style="display: none; margin-top: 20px;">
          {% if past_routes %}
            <div class="past-routes">
              <h3>Your Recent Routes</h3>
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>From</th>
                    <th>To</th>
                    <th>Distance</th>
                    <th>Time</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for route in past_routes %}
                    <tr>
                      <td>{{ route.start }}</td>
                      <td>{{ route.dest }}</td>
                      <td>{{ route.distance }} km</td>
                      <td>{{ route.time }} min</td>
                      <td>
                        <button class="btn btn-info btn-sm" onclick="loadRoute('{{ route.start }}', '{{ route.dest }}')">Load</button>
                        <a href="{{ url_for('map.delete_route', route_id=route.id) }}" onclick="return confirm('Are you sure you want to delete this route?')" class="btn btn-danger btn-sm">Delete</a>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <p>No past routes found.</p>
          {% endif %}
        </div>
      {% endif %}
    </div>
    <script>
      function togglePastRoutes() {
        const pastRoutes = document.getElementById('pastRoutesSection');
        if (pastRoutes.style.display === 'none') {
          pastRoutes.style.display = 'block';
        } else {
          pastRoutes.style.display = 'none';
        }
      }
      function loadRoute(start, dest) {
        const startSelect = document.querySelector('select[name="start"]');
        const destSelect = document.querySelector('select[name="dest"]');
        startSelect.value = start;
        destSelect.value = dest;
        startSelect.closest('form').submit();
      }
    </script>
  </body>
</html>
{% endblock %}
